<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Fiori,OData,URI,ICF,ICM," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="ODATA是Fiori和SAP的纽带，前端的开发不需要了解ABAP，后端的ABAP也不需要了解SAPUI5, 但是他们都需要了解ODATA，今天就来详细总结一下ODATA  概念ODataOData 全称是Open Data Protocol, 即开放数据协议 ,它的主要用途便是通过Web来对数据库中的数据进行查询与更新 。 OData其实不是SAP所创，他是一个设计和使用RESTful API">
<meta name="keywords" content="Fiori,OData,URI,ICF,ICM">
<meta property="og:type" content="article">
<meta property="og:title" content="Fiori-ODATA">
<meta property="og:url" content="http://yoursite.com/2017/07/20/Fiori-ODATA/index.html">
<meta property="og:site_name" content="Welcome to Jim&#39;s Blog">
<meta property="og:description" content="ODATA是Fiori和SAP的纽带，前端的开发不需要了解ABAP，后端的ABAP也不需要了解SAPUI5, 但是他们都需要了解ODATA，今天就来详细总结一下ODATA  概念ODataOData 全称是Open Data Protocol, 即开放数据协议 ,它的主要用途便是通过Web来对数据库中的数据进行查询与更新 。 OData其实不是SAP所创，他是一个设计和使用RESTful API">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804094852819.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170720165728282.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804094521415.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170724093053933.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-2017080409122461.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804094304864.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804095716847.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170722180016559.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170723164200836.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170807104855498.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804085853811.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804090000476.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150118491.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150214450.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150320962.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150341123.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150428238.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150613825.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-2017080415410698.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804151504658.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804151625423.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804151804446.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804151822342.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804152020863.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804152309644.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804152352357.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804152853408.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170810093529353.png">
<meta property="og:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170810093445208.png">
<meta property="og:updated_time" content="2017-08-10T01:35:54.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fiori-ODATA">
<meta name="twitter:description" content="ODATA是Fiori和SAP的纽带，前端的开发不需要了解ABAP，后端的ABAP也不需要了解SAPUI5, 但是他们都需要了解ODATA，今天就来详细总结一下ODATA  概念ODataOData 全称是Open Data Protocol, 即开放数据协议 ,它的主要用途便是通过Web来对数据库中的数据进行查询与更新 。 OData其实不是SAP所创，他是一个设计和使用RESTful API">
<meta name="twitter:image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804094852819.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/07/20/Fiori-ODATA/"/>





  <title>Fiori-ODATA | Welcome to Jim's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0a933f2d0877333caf78cbe836cc7b27";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Welcome to Jim's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">欢迎欢迎</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/20/Fiori-ODATA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jim Guo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170714141857819.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Jim's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Fiori-ODATA</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-20T16:12:15+08:00">
                2017-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Fiori/" itemprop="url" rel="index">
                    <span itemprop="name">Fiori</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2017/07/20/Fiori-ODATA/#SOHUCS" itemprop="discussionUrl">
                  <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="2017/07/20/Fiori-ODATA/" itemprop="commentsCount"></span>
                </a>
              
            
          

          
          
             <span id="/2017/07/20/Fiori-ODATA/" class="leancloud_visitors" data-flag-title="Fiori-ODATA">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>ODATA是Fiori和SAP的纽带，前端的开发不需要了解ABAP，后端的ABAP也不需要了解SAPUI5, 但是他们都需要了解ODATA，今天就来详细总结一下ODATA</p>
</blockquote>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="OData"><a href="#OData" class="headerlink" title="OData"></a>OData</h4><p>OData 全称是Open Data Protocol, 即开放<strong><font color="red" size="5">数据协议</font></strong> ,它的主要用途便是<strong><font color="red" size="5">通过Web来对数据库中的数据进行查询与更新</font></strong> 。</p>
<p>OData其实不是SAP所创，他是一个设计和使用<strong>RESTful</strong> API的标准协议（就是大家都要准守的规则，只要你按这个标准创建RESTful API，其它组织都可以按照OData标准中定义的方式去使用这个API获取/修改资源，就像是SQL标准和数据库之间的关系）。OData就是一个接口，基于HTTP（S）协议，各种程序和系统都可以互联互通，执行读、写、改等操作，这样SAP外部的程序就可以操作SAP的数据，甚至调用BAPI等等。相当于SAP对外又开放了一个接口，这个接口基于ODATA协议，这个接口就是SAP Netweaver Gateway。换句话说OData开放和分享了SAP的数据，这样就可以开发基于Web和Mobile的程序而不用考虑Web程序和Mobile应用是用什么技术开发的了，实现了SAP Fiori的跨平台特性。OData协议支持一系列流行的数据格式,包括JSON，XML。</p>
<p><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804094852819.png" alt=""></p>
<p><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170720165728282.png" alt=""></p>
<h4 id="REST"><a href="#REST" class="headerlink" title="REST"></a>REST</h4><p>REpresentational State Transfer，REST其实就是所有的数据操作都是通过客户端发送的一系列<strong>URI</strong>来完成，URL定位资源，用HTTP动词（GET,POST,DELETE,DETC）描述操作。</p>
<p><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804094521415.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">GET 用来获取资源，</div><div class="line">POST 用来新建或更新资源，</div><div class="line">PUT 用来更新资源，</div><div class="line">DELETE 用来删除资源。</div></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th style="text-align:left">OData Operation</th>
<th style="text-align:left">HTTP Method</th>
<th style="text-align:left">What it meant to an ABAPer</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Create</td>
<td style="text-align:left">POST</td>
<td style="text-align:left">Insert <table> from <workarea></workarea></table></td>
</tr>
<tr>
<td style="text-align:left">Read</td>
<td style="text-align:left">GET</td>
<td style="text-align:left">Select Single * From <table> into <workarea></workarea></table></td>
</tr>
<tr>
<td style="text-align:left">Update</td>
<td style="text-align:left">PUT/PATCH</td>
<td style="text-align:left">Update <table> set <workarea></workarea></table></td>
</tr>
<tr>
<td style="text-align:left">Delete</td>
<td style="text-align:left">DELETE</td>
<td style="text-align:left">Delete from <table></table></td>
</tr>
<tr>
<td style="text-align:left">Query</td>
<td style="text-align:left">GET</td>
<td style="text-align:left">Select *? From <table> Into Table</table></td>
</tr>
<tr>
<td style="text-align:left">Function Import</td>
<td style="text-align:left">GET/POST</td>
<td style="text-align:left">Everything covered by GET and POST. But only use if scenario does not fit into CRUDQ operations.</td>
</tr>
</tbody>
</table>
<h4 id="URI-amp-URL-amp-URN"><a href="#URI-amp-URL-amp-URN" class="headerlink" title="URI&amp;URL&amp;URN"></a>URI&amp;URL&amp;URN</h4><p>Uniform Resource Identifier统一资源标识符<br><br>Uniform Resource Locator统一资源定位符<br><br>Universal Resource Name 统一资源名称<br><br>三者的关系：<br><br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170724093053933.png" alt=""><br><br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-2017080409122461.png" alt=""><br></p>
<p>URI是个纯粹的句法结构，用于指定标识Web资源的字符串的各个不同部分。也就是说，URI分为三种，URL or URN or （URL and URI）,URL代表资源的路径地址，而URN代表资源的名称。通过URL和URN找到资源是对网络位置进行标识，就是URI，如：<br></p>
<ul>
<li><a href="http://example.org/absolute/URI/with/absolute/path/to/resource.txt" target="_blank" rel="external">http://example.org/absolute/URI/with/absolute/path/to/resource.txt</a></li>
<li>ftp://example.org/resource.txt</li>
</ul>
<p>返回值：<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804094304864.png" alt=""><br>日常开发中常遇到的是2xx 和 4xx 5xx，4xx就在开户的客户端找原因，5xx就在后端OData服务找原因。</p>
<h4 id="ICM"><a href="#ICM" class="headerlink" title="ICM"></a>ICM</h4><ul>
<li>ICM Internet Communication Manager是SAP Netweaver Application Server的一个组件，负责接受和发送Web请求（HTTP,HTTPS,SMTP）它是以单独的进程实施的，并且由<strong>SAP Dispatcher</strong>启动和监听。可以通过Profile 参数进行配置。<strong>TCODE:SMICM</strong><br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804095716847.png" alt=""></li>
<li>SAP Web Dispatcher 和ICM用同样的基础代码，它们之间主要的不同是 Web Dispatcher在已连接的应用服务器上负责负载均衡并且传递请求给ICMs而不是亲自处理请求，它们可以共享Profile参数和管理选项。<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170722180016559.png" alt=""><br>上图是ICM的架构，<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">The Internet Communication Manager ensures that communication between the SAP System (SAP NetWeaver Application Server) and the outside world via HTTP, HTTPS and SMTP protocols works properly. In its role as a server, the ICM can process requests from the Internet that arrive as URLs with the server/port combination that the ICM can listen to. The ICM then calls the relevant local handler for the URL in question.</div></pre></td></tr></table></figure>
</li>
</ul>
<p>总之，ICM确保了SAP应用服务器和外界通过HTTP/HTTPS/SMTP协议的交互，ICM可以侦听并处理Internet以URLs(Server+Port组合)传来的请求，然后由ICM调用URL中请求中的本地相应的handler。</p>
<h4 id="ICF"><a href="#ICF" class="headerlink" title="ICF"></a>ICF</h4><ul>
<li>ICF Internet Communication Framework 允许用户通过HTTP, HTTPS and SMTP协议与SAP系统进行通信，是应用服务器的一个集成组件。它有几个特点：1. 灵活性，通过ICF用户可从任何有互联网的地方连接到SAP系统。2.方便配置，只需要很简单的安装和配置就可以实现。3.安全性，HTTPS协议保证了数据传输的安全性，安全程度与RFC/SNC相当。<br><br>ICF提供了处理HTTP请求的基础结构，HTTP请求调用ICF Server中的一个服务，这个服务可以包含一个或多个负责执行ABAP功能的<strong>HTTP request handlers</strong>。<br><br>SAP提供很多标准功能对应的ICF Serivces和request handlers。<br>用户可以定义自己的HTTP request handlers和Services。<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170723164200836.png" alt=""></li>
</ul>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>今天我们就通过一个实例来介绍这三个问题：</p>
<ol>
<li>怎么样就是创建了一个OData服务？</li>
<li>OData服务怎么使用？</li>
<li>开发OData过程中应该注意什么？</li>
</ol>
<h4 id="Tcode-SEGW"><a href="#Tcode-SEGW" class="headerlink" title="Tcode:SEGW"></a>Tcode:SEGW</h4><blockquote>
<p>方便大家记忆，<strong>SE</strong>（做为一个ABAPer最熟悉的开发TCODE都是以<strong>SE</strong>开头的，<strong>SE</strong> 38 <strong>SE</strong> 37，以后记再加一个<strong>SEGW</strong>）+ <strong>GW</strong> (<strong>G</strong> ate<strong>W</strong> ay)</p>
</blockquote>
<p><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170807104855498.png" alt=""></p>
<h5 id="1-创建或导入Data-Model"><a href="#1-创建或导入Data-Model" class="headerlink" title="1.创建或导入Data Model"></a>1.创建或导入Data Model</h5><p><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804085853811.png" alt=""><br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804090000476.png" alt=""><br></p>
<p>我们可以看到，Gateway service 分为四个部分 (左边的 panel)：</p>
<ul>
<li>Data Model: 数据模型，主要包括 Entity type,( 比如说 product entity，customer entity 等)，Entity set (Entity 的集合，多笔数据) 和 Association (Entity 之间的关联)</li>
<li>Service Implementation: Entity set 的 CRUD 实现</li>
<li>Runtime Artifacts: 基于 Entity set 的代码框架，包括数据模型 (Data model)，数据提供者 (Data provider)</li>
<li>Service maintenance：注册服务，测试服务。<br></li>
</ul>
<p>学习两个新名词：<code>Entity Type</code> 和 <code>Entity Set</code> ，实体类型和实体集，可以简单的理解 Entity Type 为 work area, 其中的Properties为work area的字段, Entity Set为Internal Table, Service implementation就是具体的数据操作方法。</p>
<h5 id="2-创建Data-Model"><a href="#2-创建Data-Model" class="headerlink" title="2. 创建Data Model"></a>2. 创建Data Model</h5><p><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150118491.png" alt=""><br>这里我们通过Import的方式进行导入创建，当然也可以手工进行entity type和entityset的创建。<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150214450.png" alt=""><br>参考表SCARR创建名称为Airline的Entity。<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150320962.png" alt=""><br>选中需要的字段<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150341123.png" alt=""><br>指定Key字段<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150428238.png" alt=""><br>点击生成，相当于激活<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804150613825.png" alt=""><br>可以看到系统将自动创建6个Class,bass class和Extended Class(EXT),其中EXT是我们将进行服务实现的类。如果不小心将代码写到了base class，那在下一次Generate时自开发代码将会被清空。<br><strong>MPC和DPC</strong><br><br>MPC：Model Provide Class<br><br>DPC: Data Provider Class<br><br>顾名思义，一个是定义数据模型的类，一个是定义和实现数据操作的类。<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-2017080415410698.png" alt=""><br>DPC提供了Gateway Service的方法实现，MPC提供了Gateway Service的接口，DPC和MPC的连接不是靠代码维系，而是通过配置。</p>
<p>到此为止，OATA Service创建完成。但这仅仅是创建的<strong>后端服务</strong>，前端想要使用这个服务还要将这个<strong>后端的服务注册到前端</strong>，也就是注册到Gateway Hub上，向外部暴露我们的OData Service。</p>
<h5 id="3-注册服务"><a href="#3-注册服务" class="headerlink" title="3. 注册服务"></a>3. 注册服务</h5><p>TCODE:<strong>/IWFND/MAINT_SERVICE</strong></p>
<blockquote>
<p>这个Gateway的很多TCODE都是这种很长带斜杠的，还有一个常用的<strong>/IWFND/GW_CLIENT</strong> 这两个分别是Server和Client。自己想办法记忆吧</p>
</blockquote>
<p><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804151504658.png" alt=""><br>点击 ‘添加服务’<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804151625423.png" alt=""><br>找到刚刚自己创建的‘项目名+ _ SRV’ 的服务，点击’add Service’<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804151804446.png" alt=""></p>
<p><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804151822342.png" alt=""><br>回到刚才的界面，可以通过filter来找到刚刚添加的服务，选中后点击下面的’SAP Gateway Client’（这里也可以通过刚说的TCODE：/IWFND/GW_CLIENT来启动）</p>
<h5 id="测试服务"><a href="#测试服务" class="headerlink" title="测试服务"></a>测试服务</h5><p><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804152020863.png" alt=""><br>直接点击Execute，可以看到服务的测试结果，这里只是测试了服务是否连通，想要对数据的增删改，还要进行接下来的Method redefine.</p>
<h5 id="服务实现"><a href="#服务实现" class="headerlink" title="服务实现"></a>服务实现</h5><p>服务实现是指提供 CRUD 的具体实现，读取数据，SAP 一般把读取 Entity 叫做 Read，把读取 EntitySet 叫做 Query。在 SEGW 界面中 展开 Service Implementation:<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804152309644.png" alt=""><br>Go to ABAP Workbenck<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804152352357.png" alt=""></p>
<p>我们需要编写具体的代码，这样外部才能实现对 SAP 数据的增删改查。首先我们来看看  GetEntitySet 方法的编写过程。<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170804152853408.png" alt=""><br>Redifine激活后，我们再到SAP Gateway Client进行测试</p>
<p>对EntitySet的操作可以参考下表：<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170810093529353.png" alt=""></p>
<p>对Entity的操作也可以参考下表：<br><img src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170810093445208.png" alt=""></p>
<p>###参考</p>
<p><a href="http://www.odata.org/getting-started/understand-odata-in-6-steps/" target="_blank" rel="external">Understand OData in 6 steps</a><br><br><a href="http://www.odata.org/documentation/odata-version-2-0/uri-conventions/" target="_blank" rel="external">URI Conventions</a></p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="./uploads/wechat-qcode.jpg" alt="Jim Guo wechat" style="width: 200px; max-width: 100%;"/>
    <div>ex. subscribe to my blog by scanning my public wechat account</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Fiori-OData-URI-ICF-ICM/" rel="tag"># Fiori,OData,URI,ICF,ICM</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/20/MarkDown-memo/" rel="next" title="MarkDown memo">
                <i class="fa fa-chevron-left"></i> MarkDown memo
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/24/Fiori-Netweaver-Gatway/" rel="prev" title="Fiori-Netweaver Gatway">
                Fiori-Netweaver Gatway <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="SOHUCS"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://osyt5kjax.bkt.clouddn.com/markdown-img-paste-20170714141857819.png"
               alt="Jim Guo" />
          <p class="site-author-name" itemprop="name">Jim Guo</p>
           
              <p class="site-description motion-element" itemprop="description">Hi~</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#概念"><span class="nav-number">1.</span> <span class="nav-text">概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OData"><span class="nav-number">1.1.</span> <span class="nav-text">OData</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#REST"><span class="nav-number">1.2.</span> <span class="nav-text">REST</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#URI-amp-URL-amp-URN"><span class="nav-number">1.3.</span> <span class="nav-text">URI&URL&URN</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ICM"><span class="nav-number">1.4.</span> <span class="nav-text">ICM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ICF"><span class="nav-number">1.5.</span> <span class="nav-text">ICF</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实例"><span class="nav-number">2.</span> <span class="nav-text">实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Tcode-SEGW"><span class="nav-number">2.1.</span> <span class="nav-text">Tcode:SEGW</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-创建或导入Data-Model"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.创建或导入Data Model</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-创建Data-Model"><span class="nav-number">2.1.2.</span> <span class="nav-text">2. 创建Data Model</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-注册服务"><span class="nav-number">2.1.3.</span> <span class="nav-text">3. 注册服务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#测试服务"><span class="nav-number">2.1.4.</span> <span class="nav-text">测试服务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#服务实现"><span class="nav-number">2.1.5.</span> <span class="nav-text">服务实现</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jim Guo</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  




  
    <script type="text/javascript">
    (function(){
      var appid = 'cyt6NLBUa';
      var conf = '5d7fddd06fa5ced61c345e7b9bed25df';
      var width = window.innerWidth || document.documentElement.clientWidth;
      if (width < 960) {
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){
        window.changyan.api.config({appid:appid,conf:conf})});
      }
    })();
    </script>
    <script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script>
  



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("Ns9PXyOfRgVrwITbJu7Bng42-gzGzoHsz", "PF3DJeessxXCul5kGtb9Meod");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
